---
import { Clock, ArrowRight } from 'lucide-astro';
import WhatsHot from './WhatsHot.astro';

interface Article {
  title: string;
  description: string;
  category: string;
  image: string;
  href: string;
  date: string;
  readTime?: string;
  featured?: boolean;
}

import { getCollection } from 'astro:content';

interface Props {
  articles?: Article[];
}

const { articles = [] } = Astro.props;

// fetch latest posts from the content collection when no explicit articles are provided
let fetchedArticles: Article[] = [];
if (articles.length === 0) {
  const all = await getCollection('posts', ({ data }) => data.draft !== true);
  const raw = (d: { date?: string | Date; pubDate?: string | Date }) =>
    d.date || d.pubDate;
  const latestPosts = all
    .sort((a, b) => {
      const da = raw(a.data) ? new Date(raw(a.data)!).getTime() : 0;
      const db = raw(b.data) ? new Date(raw(b.data)!).getTime() : 0;
      return db - da; // newest first
    })
    .map((p) => {
      const d = raw(p.data) ? new Date(raw(p.data)!) : null;
      return {
        title: p.data.title,
        description: p.data.description || '',
        category: p.data.category || 'Tech',
        image: p.data.cover || p.data.image || '/images/placeholder.jpg',
        href: `/posts/${p.slug}`,
        date: d ? d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '',
        readTime: p.data.readTime,
        featured: p.data.featured,
      };
    });
  fetchedArticles = latestPosts;
}

// fallback to default mock data only if neither props nor fetched posts are available
const defaultArticles: Article[] = [
  {
    title: "The Ultimate Guide to Choosing Your Next Laptop in 2026",
    description: "Everything you need to know about processors, RAM, storage, and display technology to make the perfect choice for your needs.",
    category: "Tech",
    image: "/images/laptop-guide.jpg",
    href: "/tech/laptop-buying-guide-2026",
    date: "Feb 13, 2026",
    readTime: "8 min",
    featured: true,
  },
  {
    title: "Top 10 Project Management Tools Compared",
    description: "We tested the leading PM software to help you choose the right one for your team.",
    category: "SaaS",
    image: "/images/pm-tools.jpg",
    href: "/saas/project-management-comparison",
    date: "Feb 12, 2026",
    readTime: "6 min",
  },
  {
    title: "AI Writing Tools: ChatGPT vs Claude vs Gemini",
    description: "Which AI assistant is best for content creation? We put them to the test.",
    category: "Software",
    image: "/images/ai-comparison.jpg",
    href: "/software/ai-writing-comparison",
    date: "Feb 11, 2026",
    readTime: "7 min",
  },
  {
    title: "Best Mechanical Keyboards Under $150",
    description: "Premium typing experience without breaking the bank - our top picks.",
    category: "Tech",
    image: "/images/keyboards.jpg",
    href: "/tech/best-budget-keyboards",
    date: "Feb 10, 2026",
    readTime: "5 min",
  },
  {
    title: "How to Set Up a Home Office for Productivity",
    description: "Expert tips on creating the perfect workspace that boosts focus and efficiency.",
    category: "Guides",
    image: "/images/home-office.jpg",
    href: "/guides/home-office-setup",
    date: "Feb 9, 2026",
    readTime: "10 min",
  },
  {
    title: "Wireless Earbuds Showdown: AirPods vs Sony vs Bose",
    description: "Sound quality, comfort, and features compared across the top brands.",
    category: "Tech",
    image: "/images/earbuds.jpg",
    href: "/tech/wireless-earbuds-comparison",
    date: "Feb 8, 2026",
    readTime: "9 min",
  },
];

const allArticles =
  articles.length > 0
    ? articles
    : fetchedArticles.length > 0
    ? fetchedArticles
    : defaultArticles;

// Featured = latest post (first in list); regular = next 5
const featuredArticle = allArticles[0];
const regularArticles = allArticles.slice(1, 6);

const categoryColors: Record<string, string> = {
  Tech: 'var(--color-primary)',
  SaaS: '#8b5cf6',
  Software: '#10b981',
  Guides: '#f59e0b',
};
---

<section class="latest-news-section">
  <div class="container">
    <div class="section-header">
      <h2 class="section-title">Latest News & Reviews</h2>
      <p class="section-subtitle">
        Stay updated with our newest articles, reviews, and buying guides
      </p>
    </div>
    
    <div class="news-layout">
      <!-- Main Content -->
      <div class="news-main">
        <!-- Featured Article -->
        <article class="featured-article">
          <a href={featuredArticle.href} class="featured-link">
            <div class="featured-image-wrapper">
              <img 
                src={featuredArticle.image} 
                alt={featuredArticle.title}
                class="featured-image"
                loading="lazy"
              />
              <span 
                class="featured-badge"
                style={`background: ${categoryColors[featuredArticle.category]}`}
              >
                {featuredArticle.category}
              </span>
            </div>
            <div class="featured-content">
              <h3 class="featured-title">{featuredArticle.title}</h3>
              <p class="featured-description">{featuredArticle.description}</p>
              <div class="featured-meta">
                <span class="meta-item">
                  <Clock size={16} />
                  {featuredArticle.date}
                </span>
                {featuredArticle.readTime && (
                  <span class="meta-item">{featuredArticle.readTime} read</span>
                )}
              </div>
            </div>
          </a>
        </article>
        
        <!-- Regular Articles Grid -->
        <div class="articles-grid">
          {regularArticles.map((article) => (
            <article class="article-card">
              <a href={article.href} class="article-link">
                <div class="article-image-wrapper">
                  <img 
                    src={article.image} 
                    alt={article.title}
                    class="article-image"
                    loading="lazy"
                  />
                  <span 
                    class="article-badge"
                    style={`background: ${categoryColors[article.category]}`}
                  >
                    {article.category}
                  </span>
                </div>
                <div class="article-content">
                  <h4 class="article-title">{article.title}</h4>
                  <p class="article-description">{article.description}</p>
                  <div class="article-meta">
                    <span class="meta-date">{article.date}</span>
                    {article.readTime && (
                      <span class="meta-read-time">{article.readTime}</span>
                    )}
                  </div>
                </div>
              </a>
            </article>
          ))}
        </div>
        
        <!-- View All Button -->
        <div class="view-all-wrapper">
          <a href="/posts" class="btn-view-all">
            View All Articles
            <ArrowRight size={20} />
          </a>
        </div>
      </div>
      
      <!-- Sidebar -->
      <aside class="news-sidebar">
        <WhatsHot />
        
        <!-- Newsletter Widget (optional) -->
        <div class="newsletter-widget">
          <h4>Stay Updated</h4>
          <p>Get the latest reviews delivered to your inbox</p>
          <form class="newsletter-form">
            <input 
              type="email" 
              placeholder="Your email" 
              class="newsletter-input"
              required
            />
            <button type="submit" class="newsletter-button">
              Subscribe
            </button>
          </form>
        </div>
      </aside>
    </div>
  </div>
</section>

<style>
  .latest-news-section {
    background: var(--color-bg);
    padding: 4rem 0;
  }
  
  /* Section Header */
  .section-header {
    text-align: center;
    margin-bottom: 3rem;
  }
  
  .section-title {
    font-size: 2.5rem;
    font-weight: 800;
    color: var(--color-text);
    margin-bottom: 0.75rem;
  }
  
  .section-subtitle {
    font-size: 1.125rem;
    color: var(--color-text-light);
    max-width: 600px;
    margin: 0 auto;
  }
  
  /* Layout */
  .news-layout {
    display: grid;
    grid-template-columns: 1fr 360px;
    gap: 2.5rem;
    align-items: start;
  }
  
  /* Featured Article */
  .featured-article {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
    box-shadow: var(--shadow-lg);
    margin-bottom: 2.5rem;
    transition: all var(--transition-base);
  }
  
  .featured-article:hover {
    box-shadow: var(--shadow-xl);
    transform: translateY(-4px);
  }
  
  .featured-link {
    text-decoration: none;
    display: block;
  }
  
  .featured-image-wrapper {
    position: relative;
    padding-top: 56.25%; /* 16:9 aspect ratio */
    overflow: hidden;
  }
  
  .featured-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.5s ease;
  }
  
  .featured-article:hover .featured-image {
    transform: scale(1.05);
  }
  
  .featured-badge {
    position: absolute;
    top: 1.5rem;
    left: 1.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: white;
    z-index: 1;
  }
  
  .featured-content {
    padding: 2rem;
  }
  
  .featured-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--color-text);
    margin: 0 0 1rem 0;
    line-height: 1.3;
    transition: color var(--transition-base);
  }
  
  .featured-article:hover .featured-title {
    color: var(--color-primary);
  }
  
  .featured-description {
    font-size: 1.05rem;
    color: var(--color-text-light);
    line-height: 1.6;
    margin: 0 0 1.5rem 0;
  }
  
  .featured-meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    font-size: 0.9rem;
    color: var(--color-text-muted);
  }
  
  .meta-item {
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }
  
  /* Articles Grid */
  .articles-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
    margin-bottom: 2.5rem;
  }
  
  .article-card {
    background: white;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
  }
  
  .article-card:hover {
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }
  
  .article-link {
    text-decoration: none;
    display: block;
  }
  
  .article-image-wrapper {
    position: relative;
    padding-top: 60%; /* 5:3 aspect ratio */
    overflow: hidden;
  }
  
  .article-image {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }
  
  .article-card:hover .article-image {
    transform: scale(1.05);
  }
  
  .article-badge {
    position: absolute;
    top: 1rem;
    left: 1rem;
    padding: 0.25rem 0.625rem;
    border-radius: var(--radius-full);
    font-size: 0.625rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: white;
    z-index: 1;
  }
  
  .article-content {
    padding: 1.25rem;
  }
  
  .article-title {
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--color-text);
    margin: 0 0 0.625rem 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
    transition: color var(--transition-base);
  }
  
  .article-card:hover .article-title {
    color: var(--color-primary);
  }
  
  .article-description {
    font-size: 0.875rem;
    color: var(--color-text-light);
    line-height: 1.5;
    margin: 0 0 1rem 0;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .article-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--color-text-muted);
  }
  
  /* View All Button */
  .view-all-wrapper {
    text-align: center;
  }
  
  .btn-view-all {
    display: inline-flex;
    align-items: center;
    gap: 0.625rem;
    padding: 1rem 2rem;
    background: var(--gradient-action);
    color: white;
    text-decoration: none;
    font-weight: 600;
    font-size: 1.05rem;
    border-radius: var(--radius-md);
    transition: all var(--transition-base);
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
  }
  
  .btn-view-all:hover {
    background: var(--gradient-action-hover);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(249, 115, 22, 0.4);
  }
  
  /* Newsletter Widget */
  .newsletter-widget {
    background: var(--gradient-hero);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    color: white;
    margin-top: 2rem;
  }
  
  .newsletter-widget h4 {
    font-size: 1.25rem;
    margin: 0 0 0.5rem 0;
  }
  
  .newsletter-widget p {
    font-size: 0.9rem;
    margin: 0 0 1.25rem 0;
    opacity: 0.95;
  }
  
  .newsletter-form {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }
  
  .newsletter-input {
    padding: 0.75rem;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-md);
    background: rgba(255, 255, 255, 0.15);
    color: white;
    font-size: 0.9rem;
  }
  
  .newsletter-input::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }
  
  .newsletter-input:focus {
    outline: none;
    border-color: white;
    background: rgba(255, 255, 255, 0.2);
  }
  
  .newsletter-button {
    padding: 0.75rem;
    background: white;
    color: var(--color-primary);
    border: none;
    border-radius: var(--radius-md);
    font-weight: 600;
    font-size: 0.9rem;
    cursor: pointer;
    transition: all var(--transition-base);
  }
  
  .newsletter-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 255, 255, 0.3);
  }
  
  /* Responsive */
  @media (max-width: 1024px) {
    .news-layout {
      grid-template-columns: 1fr;
    }
    
    .news-sidebar {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 2rem;
    }
  }
  
  @media (max-width: 768px) {
    .latest-news-section {
      padding: 3rem 0;
    }
    
    .section-title {
      font-size: 2rem;
    }
    
    .articles-grid {
      grid-template-columns: 1fr;
    }
    
    .news-sidebar {
      grid-template-columns: 1fr;
    }
    
    .featured-title {
      font-size: 1.5rem;
    }
  }
</style>
